name: PR Merge Automation

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  close-linked-and-create-followups:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Close linked issues and create follow-up issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const text = `${pr.title || ''}\n${pr.body || ''}`;

            const issueNumbers = new Set();

            // 1) Standard close keywords, e.g. "Closes #17"
            const closeKeywordRegex = /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?[\s#]*(\d+)\b/gi;
            for (const match of text.matchAll(closeKeywordRegex)) {
              const n = Number(match[1]);
              if (Number.isInteger(n) && n > 0 && n !== pr.number) issueNumbers.add(n);
            }

            // 2) Codex task naming convention, e.g. "GH-18"
            const ghTaskRegex = /\bGH-(\d+)\b/gi;
            for (const match of text.matchAll(ghTaskRegex)) {
              const n = Number(match[1]);
              if (Number.isInteger(n) && n > 0 && n !== pr.number) issueNumbers.add(n);
            }

            // 3) Direct issue URLs in body/title
            const issueUrlRegex = new RegExp(`https://github.com/${owner}/${repo}/issues/(\\d+)`, 'gi');
            for (const match of text.matchAll(issueUrlRegex)) {
              const n = Number(match[1]);
              if (Number.isInteger(n) && n > 0 && n !== pr.number) issueNumbers.add(n);
            }

            for (const issueNumber of issueNumbers) {
              try {
                const issue = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
                if (issue.data.state === 'open') {
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `Closed automatically after merge of PR #${pr.number} into \`${pr.base.ref}\`.`
                  });
                  await github.rest.issues.update({ owner, repo, issue_number: issueNumber, state: 'closed' });
                }
              } catch (error) {
                core.warning(`Failed to close linked issue #${issueNumber}: ${error.message}`);
              }
            }

            // Optional follow-up creation.
            // Add lines in PR body with this format:
            // FOLLOWUP: <title> | labels=label1,label2 | assignees=@user1,@user2
            const followupLines = (pr.body || '')
              .split(/\r?\n/)
              .map(line => line.trim())
              .filter(line => line.toUpperCase().startsWith('FOLLOWUP:'));

            for (const rawLine of followupLines) {
              const payload = rawLine.slice('FOLLOWUP:'.length).trim();
              const [titlePart, ...options] = payload.split('|').map(p => p.trim()).filter(Boolean);
              if (!titlePart) continue;

              let labels = [];
              let assignees = [];
              for (const opt of options) {
                const [k, v] = opt.split('=').map(s => s.trim());
                if (!k || !v) continue;
                if (k.toLowerCase() === 'labels') {
                  labels = v.split(',').map(x => x.trim()).filter(Boolean);
                }
                if (k.toLowerCase() === 'assignees') {
                  assignees = v.split(',').map(x => x.trim().replace(/^@/, '')).filter(Boolean);
                }
              }

              try {
                const created = await github.rest.issues.create({
                  owner,
                  repo,
                  title: `[Follow-up] ${titlePart}`,
                  body: [
                    `Auto-created from merged PR #${pr.number}.`,
                    `Source PR: ${pr.html_url}`,
                    '',
                    'Please scope and implement this follow-up work.'
                  ].join('\n'),
                  labels,
                  assignees
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `Created follow-up issue #${created.data.number}: ${created.data.html_url}`
                });
              } catch (error) {
                core.warning(`Failed to create follow-up issue from line "${rawLine}": ${error.message}`);
              }
            }
